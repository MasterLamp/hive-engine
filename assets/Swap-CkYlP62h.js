import{n as me,K as pe,r as n,m as fe,D as be,p as ye,u as we,q as ke,s as Se,x as ge,c as v,y as Y,z as X,A as N,B as Z,C as he,G as xe,H as _e,I as ee,o as r,a as $,w as E,b as k,d as p,F as A,f as t,h as R,t as i,k as S,v as V,g as f,J as Te,L as Pe,_ as Ae,M as Ve,N as ae,O as I}from"./index-CCPLilNe.js";import{v as Ie,a as Ce,b as Be,c as Me}from"./v5-BwXzlfux.js";import{_ as De}from"./LoadingOverlay-CxOz52n3.js";import{S as te}from"./SearchSelect-BZ1OkDwa.js";var Ue={v1:Ie,v3:Ce,v4:Be,v5:Me};const Oe={class:"mb-5 mt-10"},qe={class:"mb-3"},We={class:"flex w-full items-center"},Ne={class:"rounded-r-md border border-l-0 border-gray-500 bg-gray-200 p-2 dark:border-gray-500 dark:bg-slate-600"},$e={class:"mt-1 text-sm"},Ee={class:"mb-5"},Re={class:"mb-3"},Fe={class:"flex w-full items-center"},He={class:"rounded-r-md border border-l-0 border-gray-500 bg-gray-200 p-2 dark:border-gray-500 dark:bg-slate-600"},Qe={class:"mt-1 text-sm"},Le={class:"mb-3 flex flex-wrap items-center justify-between"},je={class:"mr-3 text-sm font-bold"},ze={class:"flex items-center"},Ge={key:0,class:"mb-3 flex flex-wrap items-center justify-between"},Je={class:"mr-3 text-sm font-bold"},Ke={class:"flex items-center"},Ye={key:0,class:"alert-warning"},Xe={class:"mt-1 block font-bold"},Ze={key:1,class:"alert-warning text-center font-bold"},ea={key:2,class:"alert-warning text-center font-bold"},aa={class:"mt-10 text-center"},ta=["disabled"],ra={__name:"Swap",setup(sa){const g=me("eventBus"),F=pe(),H=n(!1),C=n(!0),h=n(!1),d=n(!1),b=n(!1),x=n(!1),y=n(!1),Q=fe.create({baseURL:be}),se=ye(),_=we(),L=ke(),B=Se(),le=ge(),l=n(null),s=n(null),u=n(""),c=n(""),M=n(null),D=n(null),T=n(5),P=n(5),U=n(0),O=v(()=>L.tokens.filter(a=>!_.settings.deprecated_tokens.includes(a.symbol))),j=v(()=>B.wallet),oe=v(()=>le.username),q=v(()=>{var a;return u.value>0&&M.value?Y(u.value*Number((a=M.value)==null?void 0:a.highestBid)*_.hivePrice,5):0}),z=v(()=>{var a;return c.value>0&&D.value?Y(c.value*Number((a=D.value)==null?void 0:a.lastPrice)*_.hivePrice,5):0}),G=v(()=>d.value||u.value<=0||c.value<=0?0:X((q.value-z.value)/q.value,3)),ne=v(()=>{const a=O.value.map(e=>({text:`${e.name} (${e.symbol})`,value:e.symbol}));return[{value:null,text:"Please select a token"},...a]}),ue=v(()=>{const a=O.value.filter(e=>l.value?e.symbol!==l.value:!0).map(e=>({text:`${e.name} (${e.symbol})`,value:e.symbol}));return[{value:null,text:"Please select a token"},...a]}),re=v(()=>{if(l.value){const a=j.value.find(e=>e.symbol===l.value);if(a)return a.balance}return 0}),ie=v(()=>{if(s.value){const a=j.value.find(e=>e.symbol===s.value);if(a)return a.balance}return 0}),de=async()=>{C.value=!0;const a=[await B.fetchWallet()];O.value.length<=0&&a.push(L.fetchTokens()),await Promise.all(a),C.value=!1},ve=async a=>{b.value&&(confirm("Swap request is in progress. If you close this modal, your swap will fail. Click cancel to stop closing the modal.")?(await F.closeAll(),W()):a.stop())},W=()=>{l.value=null,s.value=null,u.value="",c.value="",T.value=5,P.value=5,d.value=!1,b.value=!1,y.value=!1,U.value=0,x.value=!1},ce=async()=>{h.value=!0;const a={Chain:1,Account:oe.value,TokenInput:l.value,TokenInputAmount:u.value,TokenOutput:s.value,TokenOutputAmount:c.value,SwapSourceId:Ve,MaxSlippageInputToken:T.value,MaxSlippageOutputToken:P.value,BaseTokenAmount:U.value,TokenInputMemo:Ue.v4()};let e="SwapRequest";e+=`?api-version=${I}`;let m=await Q.post(e,a);m&&m.data&&m.data.Id&&(y.value=!0,await B.requestTransfer({to:ae,symbol:l.value,quantity:u.value.toString(),memo:`SwapRequest ${a.TokenInputMemo}`,eventName:"dswap-transfer-successful"})),h.value=!1},J=async({id:a})=>{d.value=!0,b.value=!0,y.value=!1,await _.validateTransaction(a,10)},K=async({error:a,contract:e,action:m,payload:w})=>{if(!a&&e==="tokens"&&m==="transfer"&&w.to===ae)try{b.value=!1,d.value=!1,y.value=!1,await F.closeAll(),W(),se.push({name:"swaps"})}catch(o){console.log(o.message)}b.value=!1,d.value=!1,y.value=!1};return N(l,async a=>{s.value&&a===s.value&&(s.value=null),a&&(M.value=a==="SWAP.HIVE"?{highestBid:1,lastPrice:1}:await Z.getMetrics(a))}),N(s,async a=>{u.value=1,l.value&&a===l.value&&(s.value=null),a&&(D.value=a==="SWAP.HIVE"?{highestBid:1,lastPrice:1}:await Z.getMetrics(a))}),N(u,()=>{s.value&&(d.value=!0)}),he(u,async()=>{if(s.value){d.value=!0;try{const a={Chain:1,TokenInput:l.value,TokenInputAmount:u.value,TokenOutput:s.value};let e="SwapRequest/CalculateSwapOutput";I&&I!="1.0"&&(e+=`?api-version=${I}`);const{data:{TokenOutputAmount:m,BaseTokenAmount:w}}=await Q.post(e,a);c.value=X(m,8),U.value=w}catch(a){console.log(a.message)}d.value=!1}},{debounce:500}),xe(()=>{g.on("dswap-transfer-successful",J),g.on("transaction-validated",K)}),_e(()=>{g.off("dswap-transfer-successful",J),g.off("transaction-validated",K)}),(a,e)=>{const m=ee("Loading"),w=ee("Spinner");return r(),$(Ae,{modelValue:H.value,"onUpdate:modelValue":e[7]||(e[7]=o=>H.value=o),"modal-id":"swapModal","click-to-close":!1,onBeforeOpen:de,onBeforeClose:ve,onClosed:W},{title:E(()=>e[8]||(e[8]=[k("Swap Tokens")])),default:E(()=>[C.value?(r(),$(m,{key:0,small:""})):(r(),p(A,{key:1},[e[17]||(e[17]=t("div",{class:"text-center"},[k(" Choose which token you would like to swap below. For more information about DSwap see the "),t("a",{href:"https://dswap.trade/faq",target:"_blank"},"FAQ"),k(". ")],-1)),R(De,{show:d.value},{default:E(()=>[t("div",Oe,[e[9]||(e[9]=t("label",{for:"fromSymbol",class:"mb-2 block font-bold"},"From",-1)),R(te,{modelValue:l.value,"onUpdate:modelValue":e[0]||(e[0]=o=>l.value=o),options:ne.value,classes:"mb-3 rounded-md"},null,8,["modelValue","options"]),l.value?(r(),p(A,{key:0},[t("div",qe,"Current balance: "+i(re.value)+" "+i(l.value),1),t("div",We,[S(t("input",{id:"fromQuantity","onUpdate:modelValue":e[1]||(e[1]=o=>u.value=o),type:"number",class:"!rounded-r-none"},null,512),[[V,u.value]]),t("div",Ne,i(l.value),1)]),t("div",$e,"Estimated value (USD): $"+i(q.value),1)],64)):f("",!0)]),t("div",Ee,[e[10]||(e[10]=t("label",{for:"toSymbol",class:"mb-2 block font-bold"},"To",-1)),R(te,{modelValue:s.value,"onUpdate:modelValue":e[2]||(e[2]=o=>s.value=o),options:ue.value,classes:"mb-3 rounded-md"},null,8,["modelValue","options"]),s.value?(r(),p(A,{key:0},[t("div",Re,"Current balance: "+i(ie.value)+" "+i(s.value),1),t("div",Fe,[S(t("input",{id:"toQuantity","onUpdate:modelValue":e[3]||(e[3]=o=>c.value=o),type:"number",class:"!rounded-r-none",readonly:""},null,512),[[V,c.value]]),t("div",He,i(s.value),1)]),t("div",Qe,"Estimated value (USD): $"+i(z.value),1)],64)):f("",!0)]),l.value&&s.value?(r(),p(A,{key:0},[e[13]||(e[13]=t("div",{class:"mb-2 font-bold"},"SWAP Settings",-1)),t("div",Le,[t("div",je,"Max Slippage ("+i(l.value)+" -> SWAP.HIVE)",1),t("div",ze,[S(t("input",{"onUpdate:modelValue":e[4]||(e[4]=o=>T.value=o),type:"number",class:"w-16 !rounded-r-none"},null,512),[[V,T.value]]),e[11]||(e[11]=t("div",{class:"rounded-r-md border border-l-0 border-gray-500 bg-gray-200 p-2 dark:border-gray-500 dark:bg-slate-600"}," % ",-1))])]),s.value!=="SWAP.HIVE"?(r(),p("div",Ge,[t("div",Je,"Max Slippage (SWAP.HIVE -> "+i(s.value)+")",1),t("div",Ke,[S(t("input",{"onUpdate:modelValue":e[5]||(e[5]=o=>P.value=o),type:"number",class:"w-16 !rounded-r-none"},null,512),[[V,P.value]]),e[12]||(e[12]=t("div",{class:"rounded-r-md border border-l-0 border-gray-500 bg-gray-200 p-2 dark:border-gray-500 dark:bg-slate-600"}," % ",-1))])])):f("",!0)],64)):f("",!0)]),_:1},8,["show"]),G.value>=.15?(r(),p("div",Ye,[e[15]||(e[15]=t("div",null," The price impact of this swap is higher than 15%. You may incur substantial losses by executing this swap. Please check carefully before proceeding. ",-1)),t("label",Xe,[S(t("input",{"onUpdate:modelValue":e[6]||(e[6]=o=>x.value=o),type:"checkbox"},null,512),[[Te,x.value]]),e[14]||(e[14]=k(" I have checked, please let me swap."))])])):f("",!0),b.value?(r(),p("div",Ze," Swap request is in progress. Please do not close this modal. ")):f("",!0),y.value?(r(),p("div",ea," Swap request is queued. Please transfer your tokens to initiate the Swapping process. ")):f("",!0),t("div",aa,[t("button",{class:"btn w-4/5 text-lg",disabled:!l.value||!s.value||u.value<=0||c.value<=0||!x.value&&G.value>=.15||h.value||d.value,onClick:Pe(ce,["prevent"])},[h.value?(r(),$(w,{key:0})):f("",!0),e[16]||(e[16]=k(" "+i(" ")+" Swap "))],8,ta)])],64))]),_:1},8,["modelValue"])}}};export{ra as default};
