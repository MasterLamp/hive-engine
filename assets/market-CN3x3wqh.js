import{a$ as p,b0 as l,a1 as m,B as i,m as h,u as y}from"./index-CCPLilNe.js";const d=a=>{let t=l(0),s=l(0);return a.map((e,r)=>{const o=l(e.price),n=l(e.quantity),c=o.times(n);return{account:e.account,price:o,quantity:n,total:c,index:r}}).reduce((e,r)=>{const o=e.find(n=>n.account==r.account&&n.price.eq(r.price));return t=t.plus(r.quantity),s=s.plus(r.total),o?(o.quantity=o.quantity.plus(r.quantity),o.total=o.total.plus(r.price.times(r.quantity)),o.volume=t,o.hive_volume=s):e.push({...r,volume:t,hive_volume:s}),e},[]).map(e=>(e.volume>999999?e.volume=(e.volume/1e6).toFixed(4)+"M":e.volume=e.volume.toFixed(8),e.quantity>999999?e.quantityFormat=(e.quantity/1e6).toFixed(4)+"M":e.quantityFormat=e.quantity.toFixed(8),{...e,account:e.account,quantityFormat:e.quantityFormat,total:e.total.toFixed(8),volume:e.volume,hive_volume:e.hive_volume.toFixed(8)}))},g=p({id:"market",state:()=>({buyBook:[],sellBook:[],buyOrders:[],sellOrders:[],tradesHistory:[],marketHistory:[],token:null,metrics:null}),getters:{buyBookFormatted(a){return d(a.buyBook)},sellBookFormatted(a){return d(a.sellBook)},openOrdersFormatted(a){return[...a.buyOrders,...a.sellOrders].sort((t,s)=>Number(s.timestamp)-Number(t.timestamp)).map(t=>({...t,type:t.tokensLocked?"BUY":"SELL",total:l(t.quantity).times(t.price),timestamp:m(new Date(t.timestamp*1e3),"Pp")}))},tradesHistoryFormatted(a){return a.tradesHistory.map(t=>({timestamp:m(new Date(t.timestamp*1e3),"Pp"),type:t.type.toUpperCase(),buyer:t.buyer,seller:t.seller,quantity:t.quantity,price:t.price,total:l(t.quantity).times(t.price).toFixed(8)}))}},actions:{async fetchOrders(a){try{const t={symbol:a},[s,e]=await Promise.all([i.getOrders(t,"buy",1e3,!0),i.getOrders(t,"sell",1e3,!1)]);this.buyBook=s,this.sellBook=e}catch{}},async fetchUserOrders(a=null,t){try{const s={account:t};a&&(s.symbol=a);const[e,r]=await Promise.all([i.getOrders(s,"buy",1e3,!0),i.getOrders(s,"sell",1e3,!1)]);this.buyOrders=e,this.sellOrders=r}catch{}},async fetchTradeHistory(a){try{const t=await i.getTradesHistory(a,null,30);this.tradesHistory=t}catch{}},async fetchToken(a){try{const[t]=await i.getTokens({symbol:a});let s={},e="https://cdn.tribaldex.com/tribaldex/token-icons/UNKNOWN.png";try{s=JSON.parse(t.metadata),s.icon&&s.icon.startsWith("http")&&(a==="BEE"?e="https://hive-engine.com/images/logo-small.png":e=s.icon.endsWith(".svg")?s.icon:`https://images.hive.blog/0x0/${s.icon}`)}catch{}this.token={...t,icon:e,metadata:s}}catch{}},async fetchTokenMetrics(a){try{const t=await i.getMetrics(a);t&&t.volumeExpiration*1e3<Date.now()&&(t.volume=0),this.metrics=t}catch{}},async fetchMarketHistory(a,t="daily"){try{const{data:s}=await h.get("https://info-api.tribaldex.com/market/ohlcv",{params:{symbol:a,interval:t}});this.marketHistory=s}catch(s){console.log(s.message)}},async requestPlaceOrder({action:a="buy",type:t="limit",symbol:s,price:e,quantity:r,total:o}){const c={contractName:"market",contractAction:a,contractPayload:{symbol:s,quantity:(a==="buy"&&t==="market"?o:r).toString(),price:e.toString()}};t==="market"&&(delete c.contractPayload.price,a==="buy"?c.contractAction="marketBuy":c.contractAction="marketSell");const u=`${t==="limit"?"Limit":"Market"} ${a==="buy"?"Buy":"Sell"} (${s})`;await y().requestBroadcastJson({message:u,json:c})},async requestCancelOrders(a){const t=a.map(e=>({contractName:"market",contractAction:"cancel",contractPayload:{type:e.type.toLowerCase(),id:e.txId}}));await y().requestBroadcastJson({message:"Cancel Order(s)",json:t})}}});export{g as u};
